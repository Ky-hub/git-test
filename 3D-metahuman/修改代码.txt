void AControlAndTransfer::SentDataWithTCP(const TArray<uint8>& PixelData, int32 Width, int32 Height)
{
    if (!DataClientSocket || !b_connectDataServer || PixelData.Num() == 0) return;

    uint32 FrameLength = PixelData.Num();
    auto ToNetOrder = [](uint32 Val) {
        return ((Val & 0xFF) << 24) | ((Val & 0xFF00) << 8) | ((Val & 0xFF0000) >> 8) | ((Val & 0xFF000000) >> 24);
    };

    uint32 NetFrameLen = ToNetOrder(FrameLength);
    uint32 NetWidth = ToNetOrder(Width);
    uint32 NetHeight = ToNetOrder(Height);

    TArray<uint8> SendBuffer;
    SendBuffer.Append(reinterpret_cast<uint8*>(&NetFrameLen), 4);
    SendBuffer.Append(reinterpret_cast<uint8*>(&NetWidth), 4);
    SendBuffer.Append(reinterpret_cast<uint8*>(&NetHeight), 4);
    SendBuffer.Append(PixelData);

    // ğŸ”¥ å…³é”®ç‚¹ 1ï¼šå…ˆç­‰å¾…å¯å†™
    if (!DataClientSocket->Wait(ESocketWaitConditions::WaitForWrite, FTimespan::FromMilliseconds(1)))
    {
        UE_LOG(LogTemp, Warning, TEXT("Socket not ready to write. Drop frame."));
        return;
    }

    // ğŸ”¥ å…³é”®ç‚¹ 2ï¼šSend å¾ªç¯åŠ é‡è¯•ä¸Šé™
    int32 TotalSent = 0;
    int RetryCount = 0;
    const int MaxRetry = 20;

    while (TotalSent < SendBuffer.Num())
    {
        int32 BytesSent = 0;
        bool bSent = DataClientSocket->Send(
            SendBuffer.GetData() + TotalSent,
            SendBuffer.Num() - TotalSent,
            BytesSent
        );

        if (!bSent || BytesSent <= 0)
        {
            RetryCount++;
            if (RetryCount >= MaxRetry)
            {
                UE_LOG(LogTemp, Warning, TEXT("Send stalled. Drop frame."));
                return;
            }

            FPlatformProcess::Sleep(0.0005f);
            continue;
        }

        TotalSent += BytesSent;
    }
}
